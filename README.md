# cs2_stats

**Оверлей статов CS2/CS:GO для OBS** — счётчик килов, смертей, K/D (и убитых куриц на картах с курицами) в реальном времени на стриме. Данные идут из игры через [Game State Integration (GSI)](https://developer.valvesoftware.com/wiki/Counter-Strike:_Global_Offensive_Game_State_Integration).

---

## Что это и кому полезно

- **Что делает:** поднимает маленький HTTP-сервер, который принимает данные от CS2/CS:GO и отдаёт страницу-оверлей. В OBS добавляешь источник «Браузер» с URL этого оверлея — на стриме отображаются твои K/D и, при наличии, счётчик куриц. Статы обновляются по ходу матча и обнуляются при смене карты.
- **Кому подойдёт:** стримерам и записывающим геймплей в CS2/CS:GO, кто хочет показывать свои килы/смерти/K/D (и куриц) поверх видео без ручного ввода. Работает при игре на том же ПК, что OBS, или когда сервер в виртуалке (Hyper-V и т.п.) в одной сети с хостом.
- **Куда «пихать»:**  
  - **Код сервера** — куда угодно (ПК с OBS или виртуалка с Python 3). Запуск: `python gsi_server.py`.  
  - **Конфиг GSI** — в папку cfg игры на Windows: `...\Counter-Strike Global Offensive\game\csgo\cfg` (и при необходимости в `...\Steam\userdata\<STEAM_ID>\730\local\cfg`). В конфиге прописан адрес сервера; после правок игру перезапустить.

**Проверенный рабочий вариант:** сервер на виртуалке (Hyper-V), игра и OBS на хосте. В конфиге обязательны блок `auth` с `token` и URI без слэша в конце.

---

## Как это работает

1. **Игра (CS2/CS:GO)** при старте читает все файлы `gamestate_integration_*.cfg` из папки cfg. В конфиге указан адрес сервера (`uri`) и блок `auth` с токеном — без них игра **не отправляет** данные.

2. **Игра** периодически шлёт на этот адрес **POST**-запросы с JSON (состояние матча: килы, смерти, карта, раунд и т.д.). Сервер мержит приходящие данные в общее состояние.

3. **Оверлей в OBS** — это источник «Браузер», который открывает страницу `.../overlay`. Страница раз в секунду запрашивает **GET /stats** и получает текущие kills, deaths и K/D. Цифры на стриме обновляются.

4. В консоли сервера видно входящие запросы: `[GET]` — от OBS/браузера, `[POST]` и `[GSI]` — от игры. Если есть `[POST]` и `[GSI] данные от игры: kills=..., deaths=...`, данные доходят.

---

## Что нужно

- Игра (CS2 или CS:GO)
- OBS Studio
- Python 3 (для сервера)
- Для варианта с VM: виртуалка в одной сети с хостом (например Hyper-V Default Switch)

---

## Рабочий вариант: сервер на виртуалке (Hyper-V)

Так настроено у нас: сервер крутится на Linux в VM, игра и OBS — на Windows-хосте.

### 1. Конфиг в игре (на ПК, где запускаешь игру)

Нужна **одна или обе** папки (у части пользователей игра читает только из одной):

| Папка | Путь |
|-------|------|
| Игра | `C:\Program Files (x86)\Steam\steamapps\common\Counter-Strike Global Offensive\game\csgo\cfg` |
| Userdata | `C:\Program Files (x86)\Steam\userdata\<STEAM_ID>\730\local\cfg` |

В `<STEAM_ID>` — твой числовой Steam ID (папка с длинным числом в `userdata`). Если не уверен — скопируй конфиг **в обе** папки.

**Файл:** скопируй из репозитория **`gamestate_integration_obs.cfg`**. В нём уже прописано:

- `"uri" "http://172.19.174.96:3002"` — замени `172.19.174.96` на **IP своей виртуалки** (на VM выполни `ip a` или `hostname -I`).
- Блок **`auth`** с **`token`** — **не удаляй**; без него игра не шлёт GSI.
- В **`uri` нет слэша в конце** — только `http://IP:3002`, не `...3002/`.

После копирования **полностью закрой игру и запусти снова**.

### 2. Запуск сервера (на виртуалке)

```bash
cd ~/cs2_tab   # или путь к проекту
python gsi_server.py
```

Сервер слушает порт **3002** на всех интерфейсах (`0.0.0.0`). Оставь терминал открытым. В консоли при игре появятся строки вида:

```
[POST] от 172.19.160.1 путь: / размер: 1249 байт
[GSI] данные от игры: kills=8, deaths=7
```

### 3. OBS (на том же ПК, где игра)

1. Добавь источник **Браузер** (Browser Source).
2. В поле **URL** укажи: `http://172.19.174.96:3002/overlay` (подставь IP своей VM).
3. Задай размер, например 400×120. Фон оверлея прозрачный.

Готово. Заходи в матч — статы на оверлее будут обновляться.

### 4. Отладка

- **Страница /debug:** в браузере на ПК открой `http://IP_VM:3002/debug` — покажет последнее состояние от игры и текущие статы (JSON).
- **Нет строк [POST] в консоли:** игра не шлёт данные. Проверь путь к конфигу, наличие блока `auth`, URI без слэша и перезапуск игры. При необходимости положи конфиг в обе папки cfg.
- **Файрвол на VM:** если с хоста не открывается /overlay или /debug, открой порт: `sudo ufw allow 3002` или временно `sudo ufw disable`.

---

## Вариант: сервер на том же ПК (localhost)

Если хочешь запускать сервер на том же компьютере, где игра и OBS:

1. Скопируй **`gamestate_integration_obs_localhost.cfg`** в папку(и) cfg игры (см. таблицу выше), при необходимости переименуй в `gamestate_integration_obs.cfg`.
2. Полностью перезапусти игру.
3. На этом ПК выполни: `python gsi_server.py`.
4. В OBS укажи URL: `http://localhost:3002/overlay`.

Формат конфига тот же (в т.ч. блок `auth` и URI без слэша).

---

## Почему именно так заработало

- **Блок `auth` с `token`** в конфиге обязателен — в рабочих примерах (node-csgo-gsi, CSGO-GSI и обсуждениях на Steam) без него игра не включает отправку GSI.
- **URI без слэша в конце** — в эталонных конфигах указано `http://127.0.0.1:3000`, а не `...3000/`.
- **Конфиг в нужной папке** — игра читает только из `game\csgo\cfg` и иногда из `userdata\...\730\local\cfg`; копирование в обе папки исключает вариант «игра читает только оттуда».
- **Перезапуск игры** после изменения конфига — GSI подхватывается при старте клиента.

---

## Файлы проекта

**Счётчик куриц:** если на карте есть курицы (Inferno, Nuke, Anubis, Ancient, Italy, Militia, Cobblestone, Rush) или ты уже убил хотя бы одну — на оверлее появляется блок «Chickens» с количеством убитых куриц. На картах без куриц блок не показывается. Данные берутся из `player.match_stats` (поле `chicken_kills` или `chickenKills`), если игра их присылает.

| Файл | Назначение |
|------|------------|
| `gsi_server.py` | HTTP-сервер: принимает GSI от игры, отдаёт /overlay и /stats |
| `gamestate_integration_obs.cfg` | Конфиг для игры при сервере на VM (подставь свой IP в `uri`) |
| `gamestate_integration_obs_localhost.cfg` | Конфиг для игры при сервере на localhost |
| `README.md` | Эта инструкция |

Другой порт (не 3002): `CS2_GSI_PORT=3003 python gsi_server.py` — тогда в конфиге и в OBS укажи тот же порт.
